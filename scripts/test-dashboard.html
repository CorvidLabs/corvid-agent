<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ollama Agent Test Suite</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'SF Mono', 'Fira Code', monospace; background: #0a0a0a; color: #e0e0e0; padding: 24px; }
  h1 { font-size: 18px; color: #8be9fd; margin-bottom: 4px; }
  .subtitle { font-size: 13px; color: #666; margin-bottom: 20px; }
  .subtitle span { color: #888; }
  .refresh-note { font-size: 11px; color: #444; position: absolute; top: 24px; right: 24px; }
  .progress-bar { width: 100%; height: 6px; background: #1a1a1a; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .tier-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 8px; }
  .test-grid { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  .test-row {
    display: grid; grid-template-columns: 56px 1fr 90px 80px;
    align-items: center; gap: 12px; padding: 10px 14px;
    background: #111; border-radius: 6px; border-left: 3px solid #333;
    font-size: 13px; transition: border-color 0.3s; cursor: pointer;
  }
  .test-row:hover { background: #161616; }
  .test-row.pass { border-left-color: #50fa7b; }
  .test-row.fail { border-left-color: #ff5555; }
  .test-row.running { border-left-color: #f1fa8c; animation: pulse 1.5s ease-in-out infinite; }
  .test-row.timeout { border-left-color: #ffb86c; }
  .test-row.pending { border-left-color: #333; opacity: 0.5; }
  .test-row.selected { outline: 1px solid #8be9fd; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  .test-id { color: #bd93f9; font-weight: 600; }
  .test-name { color: #ccc; }
  .test-status { text-align: right; font-size: 12px; }
  .test-time { text-align: right; color: #666; font-size: 12px; }
  .status-badge {
    display: inline-block; padding: 2px 8px; border-radius: 3px;
    font-size: 11px; font-weight: 600; text-transform: uppercase;
  }
  .status-badge.pass { background: #1a3a1a; color: #50fa7b; }
  .status-badge.fail { background: #3a1a1a; color: #ff5555; }
  .status-badge.running { background: #3a3a1a; color: #f1fa8c; }
  .status-badge.timeout { background: #3a2a1a; color: #ffb86c; }
  .status-badge.pending { background: #1a1a1a; color: #555; }
  .stats { display: flex; gap: 24px; margin: 20px 0; }
  .stat { text-align: center; }
  .stat-value { font-size: 28px; font-weight: 700; }
  .stat-value.green { color: #50fa7b; }
  .stat-value.red { color: #ff5555; }
  .stat-value.yellow { color: #f1fa8c; }
  .stat-value.orange { color: #ffb86c; }
  .stat-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
  .detail-panel {
    margin-top: 20px; background: #111; border-radius: 6px; overflow: hidden;
    display: none;
  }
  .detail-panel.visible { display: block; }
  .detail-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px; background: #161616; border-bottom: 1px solid #222;
  }
  .detail-header h3 { color: #8be9fd; font-size: 13px; }
  .detail-close { background: none; border: none; color: #666; cursor: pointer; font-size: 16px; font-family: inherit; }
  .detail-close:hover { color: #ccc; }
  .detail-body { padding: 16px; }
  .detail-section { margin-bottom: 14px; }
  .detail-section-title { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .detail-prompt {
    background: #0a0a0a; padding: 10px 12px; border-radius: 4px;
    font-size: 12px; line-height: 1.5; color: #999; white-space: pre-wrap;
  }
  .detail-criteria { color: #ffb86c; font-size: 12px; font-style: italic; }
  .detail-response {
    background: #0a0a0a; padding: 10px 12px; border-radius: 4px;
    font-size: 12px; line-height: 1.6; color: #ccc; white-space: pre-wrap;
    max-height: 300px; overflow-y: auto;
  }
  .detail-response.empty { color: #555; font-style: italic; }
  .detail-events { font-size: 12px; color: #bd93f9; }
  .detail-tools { font-size: 12px; color: #8be9fd; }
  .detail-tools li { margin: 3px 0; list-style: none; }
  .detail-tools li::before { content: '> '; color: #444; }
  .detail-meta { display: flex; gap: 16px; font-size: 12px; color: #666; }
  .detail-meta span { }
  .detail-meta .val { color: #ccc; }
  .tier-summary { display: flex; gap: 16px; margin-bottom: 20px; }
  .tier-card {
    flex: 1; padding: 12px; background: #111; border-radius: 6px;
    text-align: center; border-top: 2px solid #333;
  }
  .tier-card.pass { border-top-color: #50fa7b; }
  .tier-card.fail { border-top-color: #ff5555; }
  .tier-card.pending { border-top-color: #333; }
  .tier-card h3 { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .tier-card .score { font-size: 20px; font-weight: 700; color: #ccc; }
  .last-update { font-size: 11px; color: #333; margin-top: 16px; text-align: center; }
</style>
</head>
<body>

<h1>Ollama Agent Test Suite</h1>
<div class="subtitle">qwen3:8b &middot; <span id="agent-name">Qwen Coder</span></div>
<div class="refresh-note">auto-refresh 5s</div>

<div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

<div class="stats">
  <div class="stat"><div class="stat-value green" id="stat-pass">-</div><div class="stat-label">Passed</div></div>
  <div class="stat"><div class="stat-value red" id="stat-fail">-</div><div class="stat-label">Failed</div></div>
  <div class="stat"><div class="stat-value orange" id="stat-timeout">-</div><div class="stat-label">Timeout</div></div>
  <div class="stat"><div class="stat-value yellow" id="stat-running">-</div><div class="stat-label">Running</div></div>
  <div class="stat"><div class="stat-value" id="stat-pending" style="color:#555">-</div><div class="stat-label">Pending</div></div>
</div>

<div class="tier-summary" id="tier-summary"></div>

<div id="test-list"></div>

<div class="detail-panel" id="detail-panel">
  <div class="detail-header">
    <h3 id="detail-title"></h3>
    <button class="detail-close" onclick="closeDetail()">&times;</button>
  </div>
  <div class="detail-body">
    <div class="detail-section">
      <div class="detail-meta" id="detail-meta"></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Prompt</div>
      <div class="detail-prompt" id="detail-prompt"></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Pass Criteria</div>
      <div class="detail-criteria" id="detail-criteria"></div>
    </div>
    <div class="detail-section" id="detail-events-section" style="display:none">
      <div class="detail-section-title">Events</div>
      <div class="detail-events" id="detail-events"></div>
    </div>
    <div class="detail-section" id="detail-tools-section" style="display:none">
      <div class="detail-section-title">Tool Calls</div>
      <ul class="detail-tools" id="detail-tools"></ul>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Response</div>
      <div class="detail-response" id="detail-response"></div>
    </div>
  </div>
</div>

<div class="last-update" id="last-update"></div>

<script>
const API = 'http://localhost:3000';
const RESULTS_URL = '/results.json';

const TEST_DEFS = [
  { id: 'T1.1', tier: 1, name: 'Tool calling accuracy' },
  { id: 'T1.2', tier: 1, name: 'Multi-step tool chain' },
  { id: 'T1.3', tier: 1, name: 'Instruction following' },
  { id: 'T1.4', tier: 1, name: 'Not hallucinating' },
  { id: 'T2.1', tier: 2, name: 'Code comprehension' },
  { id: 'T2.2', tier: 2, name: 'Bug identification' },
  { id: 'T2.3', tier: 2, name: 'Architectural reasoning' },
  { id: 'T2.4', tier: 2, name: 'Code suggestion' },
  { id: 'T3.1', tier: 3, name: 'Critical evaluation' },
  { id: 'T3.2', tier: 3, name: 'Synthesis ability' },
  { id: 'T3.3', tier: 3, name: 'Staying in role' },
];

const TIER_NAMES = { 1: 'Basic Competence', 2: 'Reasoning Quality', 3: 'Council Readiness' };
const TIER_REQUIRED = { 1: [4,4], 2: [3,4], 3: [2,3] };

let resultsData = new Map(); // testId -> result from JSON
let selectedTest = null;

function classify(session, result) {
  // Prefer result data (from the test script) over session status
  if (result) {
    if (result.status === 'completed') return 'pass';
    if (result.status === 'timeout') return 'timeout';
    if (result.status === 'error') return 'fail';
  }
  if (!session) return 'pending';
  const s = session.status;
  if (s === 'running') return 'running';
  if (s === 'idle') return session.totalTurns > 0 ? 'pass' : 'timeout';
  if (s === 'error') return 'fail';
  if (s === 'stopped') return 'fail';
  return 'pending';
}

function formatTime(session, result) {
  if (result && result.durationMs) {
    return (result.durationMs / 1000).toFixed(1) + 's';
  }
  if (!session || !session.createdAt) return '';
  const created = new Date(session.createdAt.includes('T') ? session.createdAt : session.createdAt.replace(' ', 'T') + 'Z');
  if (session.status === 'running') {
    const elapsed = (Date.now() - created.getTime()) / 1000;
    return Math.floor(elapsed) + 's...';
  }
  return '';
}

async function fetchResults() {
  try {
    const res = await fetch(RESULTS_URL);
    if (res.ok) {
      const data = await res.json();
      resultsData.clear();
      for (const r of data) {
        resultsData.set(r.id, r);
      }
    }
  } catch { /* ignore */ }
}

async function refresh() {
  try {
    await fetchResults();

    const res = await fetch(`${API}/api/sessions?limit=100`);
    const sessions = await res.json();

    // Match test sessions by name pattern "Test: T1.1 ..."
    const testSessions = new Map();
    for (const s of sessions) {
      const m = s.name?.match(/^Test:\s+(T\d+\.\d+)/);
      if (m) {
        const existing = testSessions.get(m[1]);
        if (!existing || new Date(s.createdAt) > new Date(existing.createdAt)) {
          testSessions.set(m[1], s);
        }
      }
    }

    // Build stats
    let pass = 0, fail = 0, timeout = 0, running = 0, pending = 0;
    const testStates = TEST_DEFS.map(t => {
      const session = testSessions.get(t.id);
      const result = resultsData.get(t.id);
      const state = classify(session, result);
      if (state === 'pass') pass++;
      else if (state === 'fail') fail++;
      else if (state === 'timeout') timeout++;
      else if (state === 'running') running++;
      else pending++;
      return { ...t, session, result, state };
    });

    const done = pass + fail + timeout;
    const total = TEST_DEFS.length;

    document.getElementById('stat-pass').textContent = pass;
    document.getElementById('stat-fail').textContent = fail;
    document.getElementById('stat-timeout').textContent = timeout;
    document.getElementById('stat-running').textContent = running;
    document.getElementById('stat-pending').textContent = pending;

    // Progress bar
    const pct = ((done + running * 0.5) / total) * 100;
    const fill = document.getElementById('progress-fill');
    fill.style.width = pct + '%';
    fill.style.background = fail > 0
      ? 'linear-gradient(90deg, #50fa7b, #ff5555)'
      : 'linear-gradient(90deg, #50fa7b, #8be9fd)';

    // Tier summary
    const tierHtml = [1, 2, 3].map(tier => {
      const tests = testStates.filter(t => t.tier === tier);
      const passed = tests.filter(t => t.state === 'pass').length;
      const total = tests.length;
      const [need] = TIER_REQUIRED[tier];
      const allDone = tests.every(t => t.state !== 'running' && t.state !== 'pending');
      const tierPass = allDone && passed >= need;
      const tierFail = allDone && passed < need;
      const cls = tierPass ? 'pass' : tierFail ? 'fail' : 'pending';
      return `<div class="tier-card ${cls}">
        <h3>Tier ${tier}: ${TIER_NAMES[tier]}</h3>
        <div class="score">${passed}/${total}</div>
      </div>`;
    }).join('');
    document.getElementById('tier-summary').innerHTML = tierHtml;

    // Test list grouped by tier
    let listHtml = '';
    for (const tier of [1, 2, 3]) {
      listHtml += `<div class="tier-label">Tier ${tier}: ${TIER_NAMES[tier]}</div><div class="test-grid">`;
      for (const t of testStates.filter(x => x.tier === tier)) {
        const statusLabel = {
          pass: 'PASS', fail: 'FAIL', timeout: 'TIMEOUT', running: 'RUNNING', pending: 'PENDING'
        }[t.state];
        const time = formatTime(t.session, t.result);
        const turns = t.session ? `${t.session.totalTurns}t` : '';
        const hasResult = resultsData.has(t.id);
        const sel = selectedTest === t.id ? ' selected' : '';
        listHtml += `<div class="test-row ${t.state}${sel}" onclick="showDetail('${t.id}')">
          <span class="test-id">${t.id}</span>
          <span class="test-name">${t.name}${hasResult ? '' : ''}</span>
          <span class="test-status"><span class="status-badge ${t.state}">${statusLabel}</span></span>
          <span class="test-time">${time} ${turns}</span>
        </div>`;
      }
      listHtml += '</div>';
    }
    document.getElementById('test-list').innerHTML = listHtml;

    // Refresh detail panel if open
    if (selectedTest) showDetail(selectedTest, true);

    document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch (e) {
    document.getElementById('last-update').textContent = 'Error: ' + e.message;
  }
}

function showDetail(testId, isRefresh) {
  selectedTest = testId;
  const def = TEST_DEFS.find(t => t.id === testId);
  const result = resultsData.get(testId);
  const panel = document.getElementById('detail-panel');

  document.getElementById('detail-title').textContent = `${testId}: ${def?.name || 'Unknown'}`;

  // Meta
  const meta = [];
  if (result) {
    meta.push(`Status: <span class="val">${result.status}</span>`);
    meta.push(`Time: <span class="val">${(result.durationMs / 1000).toFixed(1)}s</span>`);
    meta.push(`Tools: <span class="val">${result.toolCalls?.length || 0}</span>`);
  }
  document.getElementById('detail-meta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');

  // Prompt
  document.getElementById('detail-prompt').textContent = result?.prompt || def?.prompt || '';
  document.getElementById('detail-criteria').textContent = result?.passCriteria || def?.passCriteria || '';

  // Events
  const eventsSection = document.getElementById('detail-events-section');
  if (result?.events?.length) {
    document.getElementById('detail-events').textContent = result.events.join(' -> ');
    eventsSection.style.display = '';
  } else {
    eventsSection.style.display = 'none';
  }

  // Tool calls
  const toolsSection = document.getElementById('detail-tools-section');
  if (result?.toolCalls?.length) {
    document.getElementById('detail-tools').innerHTML = result.toolCalls.map(t => `<li>${escHtml(t)}</li>`).join('');
    toolsSection.style.display = '';
  } else {
    toolsSection.style.display = 'none';
  }

  // Response
  const respEl = document.getElementById('detail-response');
  if (result?.response) {
    respEl.textContent = result.response;
    respEl.classList.remove('empty');
  } else if (result) {
    respEl.textContent = '(no response captured)';
    respEl.classList.add('empty');
  } else {
    respEl.textContent = '(waiting for test to complete...)';
    respEl.classList.add('empty');
  }

  panel.classList.add('visible');
  if (!isRefresh) panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeDetail() {
  selectedTest = null;
  document.getElementById('detail-panel').classList.remove('visible');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
